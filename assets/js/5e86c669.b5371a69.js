"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[141],{3905:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>g});var a=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var m=a.createContext({}),s=function(e){var n=a.useContext(m),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},p=function(e){var n=s(e.components);return a.createElement(m.Provider,{value:n},e.children)},d="mdxType",c={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},u=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,i=e.originalType,m=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),d=s(t),u=r,g=d["".concat(m,".").concat(u)]||d[u]||c[u]||i;return t?a.createElement(g,o(o({ref:n},p),{},{components:t})):a.createElement(g,o({ref:n},p))}));function g(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var i=t.length,o=new Array(i);o[0]=u;var l={};for(var m in n)hasOwnProperty.call(n,m)&&(l[m]=n[m]);l.originalType=e,l[d]="string"==typeof e?e:r,o[1]=l;for(var s=2;s<i;s++)o[s]=t[s];return a.createElement.apply(null,o)}return a.createElement.apply(null,t)}u.displayName="MDXCreateElement"},70:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>m,contentTitle:()=>o,default:()=>c,frontMatter:()=>i,metadata:()=>l,toc:()=>s});var a=t(7462),r=(t(7294),t(3905));const i={sidebar_position:4,title:"Migration CLI",slug:"cli"},o=void 0,l={unversionedId:"migration-cli",id:"migration-cli",title:"Migration CLI",description:"The intended use of the CLI tool is to be able to migrate all or specific models based on migration sub-commands.",source:"@site/docs/migration-cli.md",sourceDirName:".",slug:"/cli",permalink:"/sql-migrator/cli",draft:!1,tags:[],version:"current",sidebarPosition:4,frontMatter:{sidebar_position:4,title:"Migration CLI",slug:"cli"},sidebar:"docsSidebar",previous:{title:"Migration Infrastructure",permalink:"/sql-migrator/infrastructure"},next:{title:"Execute Data Migration",permalink:"/sql-migrator/execution"}},m={},s=[{value:"Infrastructure",id:"infrastructure",level:2},{value:"CliCommand",id:"clicommand",level:3},{value:"CliApp",id:"cliapp",level:3},{value:"Building a Migration CLI",id:"building-a-migration-cli",level:2},{value:"Setup",id:"setup",level:3},{value:"MigrateCommand",id:"migratecommand",level:3},{value:"TranslatorCommand",id:"translatorcommand",level:3},{value:"Migration Workflow",id:"migration-workflow",level:3},{value:"Department",id:"department",level:3},{value:"Employee",id:"employee",level:3},{value:"ContactInfo",id:"contactinfo",level:3},{value:"Full",id:"full",level:3}],p={toc:s},d="wrapper";function c(e){let{components:n,...t}=e;return(0,r.kt)(d,(0,a.Z)({},p,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"The intended use of the CLI tool is to be able to migrate all or specific models based on migration sub-commands."),(0,r.kt)("p",null,"For instance, ",(0,r.kt)("inlineCode",{parentName:"p"},"migrator migrate full")," will perform the full data migration while ",(0,r.kt)("inlineCode",{parentName:"p"},"migrator migrate department")," will only migrate ",(0,r.kt)("inlineCode",{parentName:"p"},"Department")," records."),(0,r.kt)("p",null,"The sections that follow will define the underlying CLI app infrastructure, then walk through building out the CLI app itself."),(0,r.kt)("h2",{id:"infrastructure"},"Infrastructure"),(0,r.kt)("p",null,"The CLI infrastructure extends the ",(0,r.kt)("a",{parentName:"p",href:"https://learn.microsoft.com/en-us/dotnet/standard/commandline/"},(0,r.kt)("strong",{parentName:"a"},"System.CommandLine"))," library to simplify the creation of a CLI app. It is defined in the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/JaimeStill/sql-migrator/tree/main/src/Cli"},(0,r.kt)("inlineCode",{parentName:"a"},"Cli"))," console app project root."),(0,r.kt)("h3",{id:"clicommand"},"CliCommand"),(0,r.kt)("p",null,"The ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/JaimeStill/sql-migrator/blob/main/src/Cli/CliCommand.cs"},(0,r.kt)("inlineCode",{parentName:"a"},"CliCommand"))," class simplifies the interface for generating a command."),(0,r.kt)("p",null,"To create an instance of ",(0,r.kt)("inlineCode",{parentName:"p"},"CliCommand"),", you must provide the following:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"name")," - how to call the sub-command (i.e. - ",(0,r.kt)("inlineCode",{parentName:"li"},"migrate"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"full"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"department"),")"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"description")," - the description of the command that will be shown when showing help and usage information with ",(0,r.kt)("inlineCode",{parentName:"li"},"-?"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"-h"),", or ",(0,r.kt)("inlineCode",{parentName:"li"},"--help"),".")),(0,r.kt)("p",null,"The following are optional arguments, but at a minimum either ",(0,r.kt)("inlineCode",{parentName:"p"},"@delegate")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"commands")," should be provided:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"@delegate")," - the delegate method to execute when the command is called"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"options")," - user-provided CLI arguments whose values are passed to ",(0,r.kt)("inlineCode",{parentName:"li"},"@delegate"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"See ",(0,r.kt)("a",{parentName:"li",href:"https://learn.microsoft.com/en-us/dotnet/standard/commandline/define-commands?source=recommendations#define-options"},(0,r.kt)("inlineCode",{parentName:"a"},"Define options"))))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"commands")," - subcommands that are reachable through this command",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"See ",(0,r.kt)("a",{parentName:"li",href:"https://learn.microsoft.com/en-us/dotnet/standard/commandline/define-commands?source=recommendations#define-subcommands"},(0,r.kt)("inlineCode",{parentName:"a"},"Define subcommands")))))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cs",metastring:'title="CliCommand.cs"',title:'"CliCommand.cs"'},"using System.CommandLine;\nusing System.CommandLine.NamingConventionBinder;\n\nnamespace Cli;\npublic abstract class CliCommand\n{\n    readonly string name;\n    readonly string description;\n    readonly Delegate? @delegate;\n    readonly List<Option>? options;\n    readonly List<CliCommand>? commands;\n\n    public CliCommand(\n        string name,\n        string description,\n        Delegate? @delegate = null,\n        List<Option>? options = null,\n        List<CliCommand>? commands = null\n    )\n    {\n        this.name = name;\n        this.description = description;\n        this.@delegate = @delegate;\n        this.options = options;\n        this.commands = commands;\n    }\n\n    public Command Build()\n    {\n        Command command = new(name, description);\n\n        if (@delegate is not null)\n            command.Handler = CommandHandler.Create(@delegate);\n\n        options?.ForEach(command.AddOption);\n\n        if (commands?.Count > 0)\n            commands\n              .Select(c => c.Build())\n              .ToList()\n              .ForEach(command.AddCommand);\n\n        return command;\n    }\n}\n")),(0,r.kt)("h3",{id:"cliapp"},"CliApp"),(0,r.kt)("p",null,"The ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/JaimeStill/sql-migrator/blob/main/src/Cli/CliApp.cs"},(0,r.kt)("inlineCode",{parentName:"a"},"CliApp"))," class simplifies the interface for defining the ",(0,r.kt)("a",{parentName:"p",href:"https://learn.microsoft.com/en-us/dotnet/standard/commandline/define-commands?source=recommendations#define-a-root-command"},"root command"),"."),(0,r.kt)("p",null,"To create an instance of ",(0,r.kt)("inlineCode",{parentName:"p"},"CliApp"),", you provide the following:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"description")," - the description of the CLI app"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"commands")," - the subcommands exposed by the CLI"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"globals")," (optional) - the global CLI arguments",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"See ",(0,r.kt)("a",{parentName:"li",href:"https://learn.microsoft.com/en-us/dotnet/standard/commandline/define-commands?source=recommendations#global-options"},"Global options"))))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cs",metastring:'title="CliApp.cs"',title:'"CliApp.cs"'},"using System.CommandLine;\n\nnamespace Cli;\npublic class CliApp\n{\n    readonly RootCommand root;\n\n    public CliApp(\n        string description,\n        List<CliCommand> commands,\n        List<Option>? globals = null\n    )\n    {\n        root = new(description);\n\n        if (globals?.Count > 0)\n            globals.ForEach(root.AddGlobalOption);\n\n        commands\n            .Select(x => x.Build())\n            .ToList()\n            .ForEach(root.AddCommand);\n    }\n\n    public Task InvokeAsync(params string[] args) =>\n        root.InvokeAsync(args);\n}\n")),(0,r.kt)("h2",{id:"building-a-migration-cli"},"Building a Migration CLI"),(0,r.kt)("p",null,"The CLI app itself is initialized as a console application via ",(0,r.kt)("inlineCode",{parentName:"p"},"dotnet new console")," at ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/JaimeStill/sql-migrator/tree/main/src/Cli"},(0,r.kt)("inlineCode",{parentName:"a"},"Cli")),". Before jumping into building out the migration code, some adjustments to the console app need to be explained."),(0,r.kt)("h3",{id:"setup"},"Setup"),(0,r.kt)("p",null,"In ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/JaimeStill/sql-migrator/blob/main/src/Cli/Cli.csproj#L8"},(0,r.kt)("inlineCode",{parentName:"a"},"Cli.csproj")),", the assembly name has been changed to facilitate a CLI-friendly name: ",(0,r.kt)("inlineCode",{parentName:"p"},"<AssemblyName>migrator</AssemblyName>"),". When the project is built and released, this causes the executable to be named ",(0,r.kt)("inlineCode",{parentName:"p"},"migrator")," instead of ",(0,r.kt)("inlineCode",{parentName:"p"},"Cli"),", enabling the full sequence of commands to flow as: ",(0,r.kt)("inlineCode",{parentName:"p"},"migrator migrate <sub-command>"),"."),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/JaimeStill/sql-migrator/blob/main/src/Cli/Program.cs"},(0,r.kt)("inlineCode",{parentName:"a"},"Program.cs"))," initializes the root command via initializing and invoking a ",(0,r.kt)("inlineCode",{parentName:"p"},"CliApp"),":"),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("p",{parentName:"admonition"},"All sub-commands are defined in the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/JaimeStill/sql-migrator/tree/main/src/Cli/Commands"},(0,r.kt)("inlineCode",{parentName:"a"},"Commands"))," sub-directory.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cs",metastring:'title="Program.cs"',title:'"Program.cs"'},'using Cli;\nusing Cli.Commands;\n\nawait new CliApp(\n    "V2 Data Migrator",\n    new()\n    {\n        new MigrateCommand(),\n        new TestCommand()\n    }\n).InvokeAsync(args);\n')),(0,r.kt)("h3",{id:"migratecommand"},"MigrateCommand"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"migrate")," sub-command is defined as ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/JaimeStill/sql-migrator/blob/main/src/Cli/Commands/Migrate/MigrateCommand.cs"},(0,r.kt)("inlineCode",{parentName:"a"},"MigrateCommand"))," and is a container for all of the migration sub-commands."),(0,r.kt)("p",null,"A ",(0,r.kt)("inlineCode",{parentName:"p"},"migrate")," sub-command maps to one or more ",(0,r.kt)("inlineCode",{parentName:"p"},"Translator")," objects. It passes in the provided ",(0,r.kt)("inlineCode",{parentName:"p"},"--v1"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"--v2"),", and ",(0,r.kt)("inlineCode",{parentName:"p"},"--migrator")," arguments to the ",(0,r.kt)("inlineCode",{parentName:"p"},"Translator")," constructor and executes the ",(0,r.kt)("inlineCode",{parentName:"p"},"Translator.Migrate()")," method."),(0,r.kt)("p",null,"It will end up looking like this once all of the commands are built:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cs",metastring:'title="MigrateCommand.cs"',title:'"MigrateCommand.cs"'},'using System.CommandLine;\n\nnamespace Cli.Commands;\npublic class MigrateCommand : CliCommand\n{\n    public MigrateCommand() : base(\n        "migrate",\n        "Test out migration patterns",\n        options: new()\n        {\n            new Option<string>(\n                new string[] { "--v1" },\n                description: "v1 server and database object in connections.json",\n                getDefaultValue: () => "Origin"\n            ),\n            new Option<string>(\n                new string[] { "--v2" },\n                description: "v2 server and database object in connections.json",\n                getDefaultValue: () => "Target"\n            ),\n            new Option<string>(\n                new string[] { "--migrator", "-m" },\n                description: "migrator db connection string key in connections.json",\n                getDefaultValue: () => "Migration"\n            )\n        },\n        commands: new()\n        {\n            new ContactInfoCommand(),\n            new DepartmentCommand(),\n            new EmployeeCommand(),\n            new FullCommand()\n        }\n    )\n    { }\n}\n')),(0,r.kt)("h3",{id:"translatorcommand"},"TranslatorCommand"),(0,r.kt)("p",null,"To simplify the process of defining ",(0,r.kt)("inlineCode",{parentName:"p"},"migrate")," subcommands, an abstract ",(0,r.kt)("inlineCode",{parentName:"p"},"TranslatorCommand<T, E>")," class has been defined that:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Constrains ",(0,r.kt)("inlineCode",{parentName:"li"},"T")," to ",(0,r.kt)("inlineCode",{parentName:"li"},"Translator<E>")),(0,r.kt)("li",{parentName:"ul"},"Constrains ",(0,r.kt)("inlineCode",{parentName:"li"},"E")," to ",(0,r.kt)("inlineCode",{parentName:"li"},"IMigrationTarget")),(0,r.kt)("li",{parentName:"ul"},"Standardizes logging messages to the console"),(0,r.kt)("li",{parentName:"ul"},"Initializes a ",(0,r.kt)("inlineCode",{parentName:"li"},"T")," through ",(0,r.kt)("inlineCode",{parentName:"li"},"Activator.CreateInstance")),(0,r.kt)("li",{parentName:"ul"},"Executes ",(0,r.kt)("inlineCode",{parentName:"li"},"T.Migrate()"))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cs",metastring:'title="TranslatorCommand.cs"',title:'"TranslatorCommand.cs"'},'using Core.Schema;\nusing Core.Sql;\n\nnamespace Cli.Commands;\npublic abstract class TranslatorCommand<T, E> : CliCommand\nwhere T : Translator<E>\nwhere E : IMigrationTarget\n{\n    public TranslatorCommand(\n        string description\n    ) : base(\n        typeof(E).Name.ToLower(),\n        description,\n        new Func<string, string, string, Task>(Call)\n    )\n    { }\n\n    static async Task Call(string v1, string v2, string migrator)\n    {\n        ConsoleColor origin = Console.ForegroundColor;\n        string entity = typeof(E).Name;\n\n        try\n        {\n            Console.ForegroundColor = ConsoleColor.Blue;\n            Console.WriteLine($"Migrating {entity} records...");\n\n            Console.ForegroundColor = ConsoleColor.Gray;\n            T? translator = Activator.CreateInstance(typeof(T), new object[] { v1, v2, migrator }) as T;\n\n            if (translator is not null)\n            {\n                List<E> records = await translator.Migrate();\n                Console.ForegroundColor = ConsoleColor.Green;\n                Console.WriteLine($"{records.Count} {entity} records successfully migrated!");\n            }\n        }\n        finally\n        {\n            Console.ForegroundColor = origin;\n        }\n    }\n}\n')),(0,r.kt)("p",null,"The sections that follow will define the migration development workflow, then demonstrate building out all of the infrastructure needed to perform migration of the AdventureWorks schema."),(0,r.kt)("h3",{id:"migration-workflow"},"Migration Workflow"),(0,r.kt)("p",null,"Facilitating data migration requires the following steps:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Isolating the target schema from the origin database through a SQL schema query, as demonstrated in the ",(0,r.kt)("a",{parentName:"p",href:"/schema-design#identification"},"Schema Design - Identification")," documentation.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Establishing the initial application infrastructure incorporating the schema, as shown in ",(0,r.kt)("a",{parentName:"p",href:"/schema-design#implementation"},"Schema Design - Implementation"),".")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Identifying the metadata needed during the migration and deriving a model that implements ",(0,r.kt)("inlineCode",{parentName:"p"},"IMigrationTarget"),", as demonstrated in ",(0,r.kt)("a",{parentName:"p",href:"/infrastructure#schema"},"Migration Infrastructure - Schema"),".")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Building a ",(0,r.kt)("a",{parentName:"p",href:"/infrastructure#translator"},(0,r.kt)("inlineCode",{parentName:"a"},"Translator"))," based on the SQL schema query and target schema.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Building a ",(0,r.kt)("a",{parentName:"p",href:"#clicommand"},(0,r.kt)("inlineCode",{parentName:"a"},"CliCommand"))," that initializes the ",(0,r.kt)("inlineCode",{parentName:"p"},"Translator")," and executes its ",(0,r.kt)("inlineCode",{parentName:"p"},"Migrate()")," method."))),(0,r.kt)("p",null,"The following sections will demonstrate building out data migration commands with increasing complexity. The sections will consist of:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"A header that indicates what is being migrated"),(0,r.kt)("li",{parentName:"ul"},"Links to all of the relevant infrastructure will be provided"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"Translator")," and ",(0,r.kt)("inlineCode",{parentName:"li"},"CliCommand")," definitions")),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("p",{parentName:"admonition"},"To prevent redundancies and focus on the complexity of a particular ",(0,r.kt)("inlineCode",{parentName:"p"},"Translator")," implementation, concepts will not be repeated between ",(0,r.kt)("inlineCode",{parentName:"p"},"Translator")," explanations.")),(0,r.kt)("h3",{id:"department"},"Department"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"File"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("a",{parentName:"td",href:"https://github.com/JaimeStill/sql-migrator/blob/main/queries/department-schema.sql"},"department-schema.sql")),(0,r.kt)("td",{parentName:"tr",align:null},"SQL Schema Query")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("a",{parentName:"td",href:"https://github.com/JaimeStill/sql-migrator/blob/main/src/App/Schema/Department.cs"},"Department.cs")),(0,r.kt)("td",{parentName:"tr",align:null},"App Schema")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("a",{parentName:"td",href:"https://github.com/JaimeStill/sql-migrator/blob/main/src/Core/Schema/AdventureWorks/Department.cs"},"Department.cs")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"IMigrationTarget"))))),(0,r.kt)("p",null,"The ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/JaimeStill/sql-migrator/blob/main/src/Cli/Translators/DepartmentTranslator.cs"},(0,r.kt)("inlineCode",{parentName:"a"},"DepartmentTranslator"))," represents the simplest concrete ",(0,r.kt)("inlineCode",{parentName:"p"},"Translator")," that can be defined."),(0,r.kt)("p",null,"In the definition, notice that:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"DepartmentTranslator")," derives from ",(0,r.kt)("inlineCode",{parentName:"li"},"AwTranslator<T>")," to simplify the migration workflow."),(0,r.kt)("li",{parentName:"ul"},"The format of ",(0,r.kt)("inlineCode",{parentName:"li"},"department-schema.sql")," is deconstructed to facilitate query generation."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"override string[] GetProps()")," specifies the column selection"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"override string[] RootCommands()")," specifies the table to retrieve data from"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"override string[] InsertProps()")," specifies the ",(0,r.kt)("inlineCode",{parentName:"li"},"Department")," properties to insert into the target database"),(0,r.kt)("li",{parentName:"ul"},"The additional commands provided by ",(0,r.kt)("inlineCode",{parentName:"li"},"GetByKey")," are merged with ",(0,r.kt)("inlineCode",{parentName:"li"},"RootCommands")," through the ",(0,r.kt)("inlineCode",{parentName:"li"},"AwTranslator.BuildCommands")," method")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cs",metastring:'title="DepartmentTranslator.cs"',title:'"DepartmentTranslator.cs"'},'using Core.Schema.AdventureWorks;\n\nnamespace Cli.Translators;\npublic class DepartmentTranslator : AwTranslator<Department>\n{\n    public DepartmentTranslator(\n        string source = "Origin",\n        string target = "Target",\n        string migrator = "Migration"\n    ) : base(\n        source,\n        target,\n        migrator\n    )\n    { }\n\n    protected override string[] GetProps() => new string[] {\n        "CAST([department].[DepartmentID] as nvarchar(MAX)) [SourceId],",\n        "[department].[Name] [Name],",\n        "[department].[GroupName] [Section]"\n    };\n\n    protected override string[] RootCommands() => new string[] {\n        "FROM [HumanResources].[Department] [department]"\n    };\n\n    protected override string[] InsertProps() =>\n        InsertProps(new string[] {\n            "Name",\n            "Section"\n        });\n\n    protected override Department ToV1Null() => new()\n    {\n        SourceId = "V1Null",\n        Name = "V1Null"\n    };\n\n    protected override async Task<Department?> GetByKey(string key) =>\n        await GetByKey(\n            BuildCommands(new string[] {\n                $"WHERE [department].[DepartmentID] = \'{key}\'"\n            })\n        );\n\n    public override async Task<List<Department>> Get() =>\n        await Get(RootCommands());\n}\n')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cs",metastring:'title="DepartmentCommand.cs"',title:'"DepartmentCommand.cs"'},'using Cli.Translators;\nusing Core.Schema.AdventureWorks;\n\nnamespace Cli.Commands;\npublic class DepartmentCommand : TranslatorCommand<DepartmentTranslator, Department>\n{\n    public DepartmentCommand() : base(\n        "Migrate Department from AdventureWorks to V2"\n    )\n    { }\n}\n')),(0,r.kt)("p",null,"Once the command is defined, remember to add it to the ",(0,r.kt)("inlineCode",{parentName:"p"},"commands")," argument of the ",(0,r.kt)("inlineCode",{parentName:"p"},"MigrateCommand"),"."),(0,r.kt)("h3",{id:"employee"},"Employee"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"File"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("a",{parentName:"td",href:"https://github.com/JaimeStill/sql-migrator/blob/main/queries/employee-schema.sql"},"employee-schema.sql")),(0,r.kt)("td",{parentName:"tr",align:null},"SQL Schema Query")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("a",{parentName:"td",href:"https://github.com/JaimeStill/sql-migrator/blob/main/src/App/Schema/Employee.cs"},"Employee.cs")),(0,r.kt)("td",{parentName:"tr",align:null},"App Schema")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("a",{parentName:"td",href:"https://github.com/JaimeStill/sql-migrator/blob/main/src/Core/Schema/AdventureWorks/Employee.cs"},"Employee.cs")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"IMigrationTarget"))))),(0,r.kt)("p",null,"The ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/JaimeStill/sql-migrator/blob/main/src/Cli/Translators/EmployeeTranslator.cs"},(0,r.kt)("inlineCode",{parentName:"a"},"EmployeeTranslator"))," class represents a more complex implementation of the ",(0,r.kt)("inlineCode",{parentName:"p"},"AwTranslator")," class. Particularly, notice that:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The SQL queries aggregate data from columns across multiple tables"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"DepartmentTranslator")," is initialized to ensure that ",(0,r.kt)("inlineCode",{parentName:"li"},"Employee.DepartmentId")," can be properly initialized."),(0,r.kt)("li",{parentName:"ul"},"The ",(0,r.kt)("inlineCode",{parentName:"li"},"Translator.OnMigrate")," delegate is defined to facilitate setting ",(0,r.kt)("inlineCode",{parentName:"li"},"Employee.DepartmentId")," before the record is inserted.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cs",metastring:'title="EmployeeTranslator.cs"',title:'"EmployeeTranslator.cs"'},'using Core.Schema.AdventureWorks;\n\nnamespace Cli.Translators;\npublic class EmployeeTranslator : AwTranslator<Employee>\n{\n    readonly DepartmentTranslator departmentTranslator;\n\n    public EmployeeTranslator(\n        string source = "origin",\n        string target = "target",\n        string migrator = "migration"\n    ) : base(\n        source,\n        target,\n        migrator\n    )\n    {\n        departmentTranslator = new(source, target, migrator);\n    }\n\n    protected override Func<Employee, Task<Employee>>? OnMigrate => async (Employee employee) =>\n    {\n        employee.DepartmentId = await departmentTranslator.EnsureMigrated(employee.SourceDepartmentId);\n        return employee;\n    };\n\n    protected override string[] GetProps() => new string[] {\n        "CAST([person].[BusinessEntityID] as nvarchar(MAX)) [SourceId],",\n        "CAST([history].[DepartmentID] as nvarchar(MAX)) [SourceDepartmentId],",\n        "[employee].[NationalIdNumber] [NationalId],",\n        "[person].[LastName] [LastName],",\n        "[person].[FirstName] [FirstName],",\n        "[person].[MiddleName] [MiddleName],",\n        "[employee].[LoginId] [Login],",\n        "[employee].[JobTitle] [JobTitle]"\n    };\n\n    protected override string[] RootCommands() => new string[] {\n        "FROM [Person].[person] [person]",\n        "LEFT JOIN [HumanResources].[Employee] [employee]",\n        "ON [person].[BusinessEntityID] = [employee].[BusinessEntityID]",\n        "LEFT JOIN [HumanResources].[EmployeeDepartmentHistory] [history]",\n        "ON [employee].[BusinessEntityID] = [history].[BusinessEntityID]",\n        "WHERE [person].[PersonType] = \'EM\'",\n        "AND [history].[EndDate] IS NULL"\n    };\n\n    protected override string[] InsertProps() => InsertProps(\n        new string[] {\n            "DepartmentId",\n            "NationalId",\n            "LastName",\n            "FirstName",\n            "MiddleName",\n            "Login",\n            "JobTitle"\n        }\n    );\n\n    protected override Employee ToV1Null() => new()\n    {\n        SourceId = "V1Null",\n        SourceDepartmentId = "V1Null",\n        LastName = "V1Null"\n    };\n\n    protected override async Task<Employee?> GetByKey(string key)\n    {\n        string[] query = BuildCommands(new string[] {\n            $"AND [person].[BusinessEntityID] = \'{key}\'"\n        });\n\n        return await GetByKey(\n            query\n        );\n    }\n\n    public override async Task<List<Employee>> Get() =>\n        await Get(RootCommands());\n}\n')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cs",metastring:'title="EmployeeCommand.cs"',title:'"EmployeeCommand.cs"'},'using Cli.Translators;\nusing Core.Schema.AdventureWorks;\n\nnamespace Cli.Commands;\npublic class EmployeeCommand : TranslatorCommand<EmployeeTranslator, Employee>\n{\n    public EmployeeCommand() : base(\n        "Migrate Employee from AdventureWorks to V2"\n    )\n    { }\n}\n')),(0,r.kt)("p",null,"Once the command is defined, remember to add it to the ",(0,r.kt)("inlineCode",{parentName:"p"},"commands")," argument of the ",(0,r.kt)("inlineCode",{parentName:"p"},"MigrateCommand"),"."),(0,r.kt)("h3",{id:"contactinfo"},"ContactInfo"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"File"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("a",{parentName:"td",href:"https://github.com/JaimeStill/sql-migrator/blob/main/queries/contact-info-schema.sql"},"contact-info-schema.sql")),(0,r.kt)("td",{parentName:"tr",align:null},"SQL Schema Query")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("a",{parentName:"td",href:"https://github.com/JaimeStill/sql-migrator/blob/main/src/App/Schema/ContactInfo.cs"},"ContactInfo.cs")),(0,r.kt)("td",{parentName:"tr",align:null},"App Schema")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("a",{parentName:"td",href:"https://github.com/JaimeStill/sql-migrator/blob/main/src/Core/Schema/AdventureWorks/ContactInfo.cs"},"ContactInfo.cs")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"IMigrationTarget"))))),(0,r.kt)("p",null,"Sometimes, translating from the origin schema to the target schema is more complex than simply selecting columns from one or more tables and formatting the selections to conform to the target schema format. In that case, the ",(0,r.kt)("inlineCode",{parentName:"p"},"AwTranslator")," is too restrictive to facilitate proper migration."),(0,r.kt)("p",null,"The ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/JaimeStill/sql-migrator/blob/main/src/Cli/Translators/ContactInfoTranslator.cs"},(0,r.kt)("inlineCode",{parentName:"a"},"ContactInfoTranslator"))," demonstrates such a complex migration. Particularly, notice:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The SQL schema query is actually two select queries whose results are merged through a ",(0,r.kt)("inlineCode",{parentName:"li"},"UNION"),". ",(0,r.kt)("inlineCode",{parentName:"li"},"GetPhoneQuery()")," and ",(0,r.kt)("inlineCode",{parentName:"li"},"GetEmailQuery()")," are used to compose the full data retrieval query in the ",(0,r.kt)("inlineCode",{parentName:"li"},"Get")," and ",(0,r.kt)("inlineCode",{parentName:"li"},"GetByKey")," methods."),(0,r.kt)("li",{parentName:"ul"},"Because the source of ",(0,r.kt)("inlineCode",{parentName:"li"},"ContactInfo")," could be either ",(0,r.kt)("inlineCode",{parentName:"li"},"Email")," or ",(0,r.kt)("inlineCode",{parentName:"li"},"Phone"),", the ",(0,r.kt)("inlineCode",{parentName:"li"},"SourceId")," property specified by the ",(0,r.kt)("a",{parentName:"li",href:"https://github.com/JaimeStill/sql-migrator/blob/main/migration/Schemas/AdventureWorks/ContactInfo.cs"},(0,r.kt)("inlineCode",{parentName:"a"},"ContactInfo"))," ",(0,r.kt)("inlineCode",{parentName:"li"},"IMigrationTarget")," class is actually composed of thre different values: ",(0,r.kt)("inlineCode",{parentName:"li"},"{SourceEmployeeId}.{ContactType}.{Value}"),". The ",(0,r.kt)("inlineCode",{parentName:"li"},"GetByKey")," method splits out these values to dynamically generate its query.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cs",metastring:'title="ContactInfoTranslator.cs"',title:'"ContactInfoTranslator.cs"'},'using System.Text;\nusing Core.Schema.AdventureWorks;\nusing Core.Sql;\n\nnamespace Cli.Translators;\npublic class ContactInfoTranslator : Translator<ContactInfo>\n{\n    readonly EmployeeTranslator employeeTranslator;\n\n    public ContactInfoTranslator(\n        string source = "origin",\n        string target = "target",\n        string migrator = "migration"\n    ) : base(\n        typeof(ContactInfo).Name,\n        source,\n        target,\n        migrator\n    )\n    {\n        employeeTranslator = new(source, target, migrator);\n    }\n\n    protected override Func<ContactInfo, Task<ContactInfo>>? OnMigrate => async (info) =>\n    {\n        info.EmployeeId = await employeeTranslator.EnsureMigrated(info.SourceEmployeeId);\n        return info;\n    };\n\n    protected override string[] InsertProps() => new string[] {\n        "EmployeeId",\n        "Type",\n        "ContactType",\n        "Value"\n    };\n\n    protected override ContactInfo ToV1Null() => new()\n    {\n        SourceEmployeeId = "V1Null",\n        Value = "V1Null",\n        ContactType = "V1Null"\n    };\n\n    protected static string[] GetPhoneQuery() => new string[] {\n        "SELECT",\n        "  CAST([person].[BusinessEntityID] as nvarchar(MAX)) [SourceEmployeeId],",\n        "  CAST([phone].[PhoneNumber] as nvarchar(MAX)) [Value],",\n        "  CAST([phoneType].[Name] as nvarchar(MAX)) [ContactType]",\n        "FROM [Person].[Person] [person]",\n        "LEFT JOIN [Person].[PersonPhone] [phone]",\n        "ON [person].[BusinessEntityID] = [phone].[BusinessEntityID]",\n        "LEFT JOIN [Person].[PhoneNumberType] [phoneType]",\n        "ON [phone].[PhoneNumberTypeID] = [phoneType].[PhoneNumberTypeID]",\n        "WHERE [person].[PersonType] = \'EM\'"\n    };\n\n    protected static string[] GetEmailQuery() => new string[] {\n        "SELECT",\n        "  CAST([person].[BusinessEntityID] as nvarchar(MAX)) [SourceEmployeeId],",\n        "  CAST([email].[EmailAddress] as nvarchar(MAX)) [Value],",\n        "  CAST(\'Email\' as nvarchar(MAX)) [ContactType]",\n        "FROM [Person].[Person] [person]",\n        "LEFT JOIN [Person].[EmailAddress] [email]",\n        "ON [person].[BusinessEntityID] = [email].[BusinessEntityID]",\n        "WHERE [person].[PersonType] = \'EM\'"\n    };\n\n    protected override async Task<ContactInfo?> GetByKey(string key)\n    {\n        string[] split = key.Split(\'.\');\n        string employeeId = split[0];\n        string contactType = split[1];\n        string value = split[2];\n        \n        StringBuilder query = new();\n\n        switch (contactType)\n        {\n            case "Email":\n                foreach (string line in GetEmailQuery())\n                    query.AppendLine(line);\n\n                query.AppendLine($"AND [email].[EmailAddress] = \'{value}\'");\n                break;\n            default:\n                foreach (string line in GetPhoneQuery())\n                    query.AppendLine(line);\n\n                query.AppendLine($"AND [phone].[PhoneNumber] = \'{value}\'");\n                break;\n        }\n\n        query.AppendLine($"AND [person].[BusinessEntityID] = `{employeeId}\'");\n\n        return await Config\n            .Source\n            .QueryFirstOrDefault<ContactInfo>(\n                query.ToString()\n            );\n    }\n\n    protected static string GetQuery()\n    {\n        StringBuilder query = new();\n\n        query.AppendLine("(");\n        \n        foreach (string line in GetPhoneQuery())\n            query.AppendLine($"  {line}");\n\n        query.AppendLine(")");\n        query.AppendLine("UNION");\n        query.AppendLine("(");\n\n        foreach (string line in GetEmailQuery())\n            query.AppendLine($"  {line}");\n\n        query.AppendLine(")");\n        query.AppendLine("ORDER BY [Value]");\n\n        return query.ToString();\n    }\n\n    public override async Task<List<ContactInfo>> Get()\n    {\n        string query = GetQuery();\n\n        return await Config\n            .Source\n            .Query<ContactInfo>(\n                query.ToString()\n            );\n    }\n}\n')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cs",metastring:'title="ContactInfoCommand.cs"',title:'"ContactInfoCommand.cs"'},'using Cli.Translators;\nusing Core.Schema.AdventureWorks;\n\nnamespace Cli.Commands;\npublic class ContactInfoCommand : TranslatorCommand<ContactInfoTranslator, ContactInfo>\n{\n    public ContactInfoCommand() : base(\n        "Migrate Contact Info from AdventureWorks to V2"\n    )\n    { }\n}\n')),(0,r.kt)("p",null,"Once the command is defined, remember to add it to the ",(0,r.kt)("inlineCode",{parentName:"p"},"commands")," argument of the ",(0,r.kt)("inlineCode",{parentName:"p"},"MigrateCommand"),"."),(0,r.kt)("h3",{id:"full"},"Full"),(0,r.kt)("p",null,"To facilitate performing a full migration for each table in the target database, a ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/JaimeStill/sql-migrator/blob/main/src/Cli/Commands/Migrate/FullCommand.cs"},(0,r.kt)("inlineCode",{parentName:"a"},"FullCommand"))," can be defined that intentionally specifies the order in which to execute the migration:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cs",metastring:'title="FullCommand.cs"',title:'"FullCommand.cs"'},'using Cli.Translators;\n\nnamespace Cli.Commands;\npublic class FullCommand : CliCommand\n{\n    public FullCommand() : base(\n        "full",\n        "Migrate V1 data to V2",\n        new Func<string, string, string, Task>(Call)\n    )\n    { }\n\n    static async Task Migrate<T>(string entity, Func<Task<List<T>>> migrate)\n    {\n        Console.ForegroundColor = ConsoleColor.Blue;\n        Console.WriteLine($"Migrating {entity} records...");\n\n        Console.ForegroundColor = ConsoleColor.Gray;\n        List<T> data = await migrate();\n\n        Console.ForegroundColor = ConsoleColor.Green;\n        Console.WriteLine($"{data.Count} {entity} records successfully migrated!");\n    }\n\n    static async Task Call(string v1, string v2, string migrator)\n    {\n        ConsoleColor origin = Console.ForegroundColor;\n\n        try\n        {\n            await Migrate(\n                "Department",\n                async () => await new DepartmentTranslator(v1, v2, migrator).Migrate()\n            );\n\n            await Migrate(\n                "Employee",\n                async () => await new EmployeeTranslator(v1, v2, migrator).Migrate()\n            );\n\n            await Migrate(\n                "ContactInfo",\n                async () => await new ContactInfoTranslator(v1, v2, migrator).Migrate()\n            );\n        }\n        finally\n        {\n            Console.ForegroundColor = origin;\n        }\n    }\n}\n')))}c.isMDXComponent=!0}}]);